<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai CSV Validator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loading-spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-10 w-full max-w-4xl mx-auto space-y-6">
        <!-- Title and Description -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Thai CSV Validator</h1>
            <p class="mt-2 text-gray-500">Upload a CSV file to automatically check and correct Thai spelling using AI.</p>
        </div>

        <!-- File Input and Action Buttons -->
        <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
            <input type="file" id="fileInput" accept=".csv" class="flex-grow w-full md:w-auto text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100
            "/>
            <button id="validateBtn" class="w-full md:w-auto px-6 py-2 rounded-full font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200 shadow-md">
                <i class="fas fa-play mr-2"></i> Validate CSV
            </button>
        </div>

        <!-- Loading and Status Indicators -->
        <div id="statusMessage" class="hidden text-center text-sm font-medium text-gray-600">
            <div id="loading" class="flex items-center justify-center space-x-2 hidden">
                <div class="loading-spinner h-5 w-5 border-4 rounded-full border-gray-200"></div>
                <span>Validating... Please wait.</span>
            </div>
            <div id="error" class="hidden p-3 bg-red-100 text-red-700 rounded-lg"></div>
        </div>

        <!-- Results Table -->
        <div id="resultsContainer" class="hidden mt-6 overflow-x-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Validation Results</h2>
                <button id="downloadBtn" class="px-4 py-2 rounded-full font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors duration-200 shadow-md">
                    <i class="fas fa-download mr-2"></i> Download Corrected CSV
                </button>
            </div>
            <table class="min-w-full table-auto bg-gray-50 rounded-lg shadow-sm">
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Row</th>
                        <th class="py-3 px-6 text-left">Column</th>
                        <th class="py-3 px-6 text-left">Original Text</th>
                        <th class="py-3 px-6 text-left">Corrected Text</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody" class="text-gray-600 text-sm font-light">
                    <!-- Results will be dynamically inserted here -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // API key is an empty string; the environment will provide it.
        const API_KEY = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;

        const fileInput = document.getElementById('fileInput');
        const validateBtn = document.getElementById('validateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusMessage = document.getElementById('statusMessage');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsTableBody = document.getElementById('resultsTableBody');

        // Store corrected data globally
        let correctedCsvData = '';

        // Function to show a message box instead of alert()
        function showMessage(message, type = 'error') {
            errorDiv.textContent = message;
            errorDiv.className = `p-3 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            errorDiv.style.display = 'block';
            statusMessage.style.display = 'block';
        }

        // Function to hide all status/result sections
        function resetUI() {
            statusMessage.style.display = 'none';
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            resultsContainer.style.display = 'none';
            resultsTableBody.innerHTML = '';
            downloadBtn.style.display = 'none';
        }

        // Function to call the Gemini API for spell-checking
        async function correctThaiSpelling(text) {
            // Early return for empty or non-Thai text to save API calls
            if (!text || text.trim() === '' || !/[\u0E00-\u0E7F]/.test(text)) {
                return text;
            }

            // More direct and specific prompt for better accuracy
            const prompt = `ตรวจคำสะกดภาษาไทยในประโยคนี้และแก้ไขให้ถูกต้อง: "${text}" ถ้าไม่มีคำผิด ไม่ต้องแก้ไข.`;
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            let attempts = 0;
            const maxRetries = 5;
            let delay = 1000; // 1 second

            while (attempts < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Too Many Requests
                            throw new Error('Rate limit exceeded. Retrying...');
                        }
                        const errorData = await response.json();
                        throw new Error(`API error: ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text.trim();
                    } else {
                        throw new Error('Unexpected API response structure.');
                    }
                } catch (e) {
                    console.error(`Attempt ${attempts + 1} failed:`, e.message);
                    attempts++;
                    if (attempts >= maxRetries) {
                        return `Error: Could not autocorrect. ${e.message}`;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        // Main function to handle file upload and validation
        validateBtn.addEventListener('click', async () => {
            resetUI();
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Please select a CSV file first.');
                return;
            }

            loadingDiv.style.display = 'flex';
            statusMessage.style.display = 'block';

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    if (lines.length <= 1) {
                        showMessage('CSV file is empty or has no data.');
                        loadingDiv.style.display = 'none';
                        return;
                    }

                    const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
                    const errorResults = [];
                    const correctedLines = [lines[0]]; // Start with original headers

                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i].split(',');
                        if (row.length !== headers.length) {
                            correctedLines.push(lines[i]); // Keep malformed rows as-is
                            continue;
                        }

                        const correctedRow = [...row];
                        for (let j = 0; j < row.length; j++) {
                            const originalText = row[j].trim().replace(/^"|"$/g, '');
                            
                            if (/[\u0E00-\u0E7F]/.test(originalText)) {
                                const correctedText = await correctThaiSpelling(originalText);
                                if (originalText.trim() !== correctedText.trim() && !correctedText.startsWith('Error:')) {
                                    errorResults.push({
                                        row: i,
                                        column: headers[j],
                                        original: originalText,
                                        corrected: correctedText
                                    });
                                    correctedRow[j] = `"${correctedText}"`;
                                }
                            }
                        }
                        correctedLines.push(correctedRow.join(','));
                    }

                    correctedCsvData = correctedLines.join('\n');
                    loadingDiv.style.display = 'none';

                    if (errorResults.length === 0) {
                        showMessage('✅ No spelling errors found!', 'success');
                    } else {
                        resultsContainer.style.display = 'block';
                        downloadBtn.style.display = 'inline-block';
                        errorResults.forEach(item => {
                            const row = document.createElement('tr');
                            row.className = 'border-b border-gray-200 hover:bg-gray-100';
                            row.innerHTML = `
                                <td class="py-3 px-6 text-left whitespace-nowrap">${item.row}</td>
                                <td class="py-3 px-6 text-left">${item.column}</td>
                                <td class="py-3 px-6 text-left">${item.original}</td>
                                <td class="py-3 px-6 text-left text-red-600 font-medium">${item.corrected}</td>
                            `;
                            resultsTableBody.appendChild(row);
                        });
                    }
                };

                reader.readAsText(file, 'UTF-8');

            } catch (e) {
                loadingDiv.style.display = 'none';
                showMessage(`Failed to process file: ${e.message}`);
                console.error("File processing error:", e);
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (!correctedCsvData) {
                showMessage('No corrected data to download. Please validate a file first.', 'error');
                return;
            }

            const blob = new Blob([correctedCsvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'corrected_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>
</html>
